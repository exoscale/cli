# Test: Config commands work without default account (fixes circular dependency)
# Previously `exo config set` failed with "default account not defined", creating a circular
# dependency where the command to set a default required a default to exist.
#
# Bug fixes:
# 1. Changed from Get("defaultAccount").(string) to GetString("defaultAccount") (panic fix)
# 2. Allow config commands (set, list, show) to run without default account (circular dependency fix)
#
# Note: With the fix, `exo config add` automatically sets the first account as default,
# so this state should not occur through normal CLI usage. However, it can still happen if:
# - User manually edits config file and removes defaultAccount
# - Config file was created by an external tool
#
# This test verifies:
# 1. No config file at all - helpful message shown
# 2. Config with accounts but no defaultAccount - config commands work, other commands fail gracefully
#
# Cannot test `exo config add` interactively in testscript due to promptui.
# See tests/integ/config_panic_test.go for integration test coverage.

# Scenario 1: First test with NO config at all
# The `exo config` command should show helpful setup message
! exec exo config
stdout 'No Exoscale CLI configuration found'
stdout 'In order to set up your configuration profile'
stdout 'https://portal.exoscale.com/iam/keys'

# Other config commands should fail gracefully
! exec exo config show

# Scenario 2: Create config with account but NO defaultAccount field
mkdir -p .config/exoscale
cp test-config.toml .config/exoscale/exoscale.toml

# Config management commands now work without a default account (fixes circular dependency)
exec exo config list
stdout 'Exoscale-Test'

# config set can now set a default account even when none exists
exec exo config set Exoscale-Test
stdout 'Default profile set to \[Exoscale-Test\]'

# After setting default, config show should work
exec exo config show
stdout 'Exoscale-Test'
stdout 'EXOtest123'

# Reset config to no default for additional tests
cp test-config.toml .config/exoscale/exoscale.toml

# Non-config commands still require default account or --use-account flag
! exec exo compute instance list
stderr 'default account not defined'

# Workaround: --use-account flag bypasses the default account requirement
exec exo --use-account Exoscale-Test config show
stdout 'Exoscale-Test'
stdout 'EXOtest123'

# Config file without defaultAccount field
# This state can occur from manual config editing or external tools  
-- test-config.toml --
[[accounts]]
name = "Exoscale-Test"
key = "EXOtest123"
secret = "testsecret123"
defaultZone = "ch-gva-2"
